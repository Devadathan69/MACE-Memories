<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MACE Memories</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg, #fdf2f8 0%, #f0f9ff 100%);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e2e8f0;
    }
    .pacifico {
      font-family: 'Pacifico', cursive;
    }
    .memory-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .memory-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    .dark .memory-card {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    .floating-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
      transition: all 0.3s ease;
    }
    .floating-btn:hover {
      transform: scale(1.1);
    }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #ec4899;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .dark .loading-spinner {
      border-top-color: #f472b6;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .nav-link {
      position: relative;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #ec4899;
      transition: width 0.3s ease;
    }
    .dark .nav-link::after {
      background-color: #f472b6;
    }
    .nav-link:hover::after {
      width: 100%;
    }
    .like-btn {
      transition: all 0.2s ease;
    }
    .like-btn:hover {
      transform: scale(1.2);
    }
    .like-btn.liked {
      color: #ec4899;
    }
    .dark .like-btn.liked {
      color: #f472b6;
    }
    .comment-box {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .comment-box.open {
      max-height: 500px;
    }
    /* Dark mode specific styles */
    .dark header {
      background: linear-gradient(to right, #4a044e, #2c3e50);
    }
    .dark .bg-white {
      background-color: #2d3748 !important;
      color: #e2e8f0;
    }
    .dark .text-gray-800 {
      color: #e2e8f0;
    }
    .dark .text-pink-700 {
      color: #f472b6;
    }
    .dark .text-pink-600 {
      color: #f9a8d4;
    }
    .dark .text-pink-500 {
      color: #f9a8d4;
    }
    .dark .bg-pink-50 {
      background-color: #4c1d95;
    }
    .dark .border-pink-200 {
      border-color: #5b21b6;
    }
    .dark .bg-gradient-to-r.from-pink-500.to-red-400 {
      background: linear-gradient(to right, #9d174d, #831843);
    }
    .dark .bg-pink-100 {
      background-color: #5b21b6;
      color: white;
    }
    .dark .bg-pink-600 {
      background-color: #9d174d;
    }
    .dark .border-pink-100 {
      border-color: #5b21b6;
    }
    .dark .text-gray-600 {
      color: #cbd5e0;
    }
    .dark .text-gray-500 {
      color: #a0aec0;
    }
    .dark .text-gray-700 {
      color: #e2e8f0;
    }
    .dark .bg-white\/80 {
      background-color: rgba(45, 55, 72, 0.8);
    }
    .dark .bg-pink-400 {
      background-color: #9d174d;
    }
    .dark .text-pink-900 {
      color: #f9a8d4;
    }
    .dark .text-pink-800 {
      color: #f9a8d4;
    }
    .dark .bg-pink-300 {
      background-color: #9d174d;
    }
    .dark .bg-red-100 {
      background-color: #7f1d1d;
    }
    .dark .bg-green-100 {
      background-color: #065f46;
    }
    .dark .text-green-700 {
      color: #6ee7b7;
    }
    .dark .bg-red-100 {
      background-color: #7f1d1d;
    }
    .dark .text-red-700 {
      color: #fca5a5;
    }
    /* Mobile menu */
    .mobile-menu {
      display: none;
    }
    @media (max-width: 768px) {
      .mobile-menu {
        display: block;
      }
      .desktop-menu {
        display: none;
      }
      .memory-card {
        max-width: 100%;
      }
      #memoryGrid {
        grid-template-columns: 1fr;
      }
      .floating-btn {
        width: 50px;
        height: 50px;
        bottom: 1rem;
        right: 1rem;
      }
      header h1 {
        font-size: 2.5rem;
      }
      header p {
        font-size: 0.9rem;
      }
      .love-note-form {
        flex-direction: column;
      }
      .love-note-form input {
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }
  </style>
  <!-- Only using Firestore from Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>

<body class="text-gray-800">
  <!-- Header and navigation -->
  <header class="bg-gradient-to-r from-pink-400 via-red-300 to-yellow-200 p-6 shadow-lg relative overflow-hidden">
    <div class="absolute inset-0 bg-white opacity-10"></div>
    <div class="relative z-10">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-5xl md:text-6xl pacifico text-center text-pink-900 drop-shadow-lg">MACE Memories</h1>
          <p class="text-center text-lg mt-2 italic text-pink-800 font-medium">Preserving the chaos, laughter, and love of our college journey</p>
        </div>
        <button id="themeToggle" class="p-2 rounded-full bg-white/30 hover:bg-white/50 transition">
          <i class="fas fa-moon text-xl text-gray-800 dark-mode-icon hidden"></i>
          <i class="fas fa-sun text-xl text-yellow-500 light-mode-icon"></i>
        </button>
      </div>
    </div>
    <div class="absolute bottom-0 left-0 right-0 h-2 bg-gradient-to-r from-pink-500 via-red-400 to-yellow-300"></div>
  </header>

  <nav class="flex justify-center space-x-6 md:space-x-10 mt-4 text-pink-700 font-semibold text-lg py-4 bg-white/80 backdrop-blur-sm sticky top-0 z-50 shadow-sm">
    <div class="desktop-menu flex space-x-6 md:space-x-10">
      <a href="#explore" class="nav-link hover:text-pink-600">Explore</a>
      <a href="#share" class="nav-link hover:text-pink-600">Share</a>
      <a href="#wall" class="nav-link hover:text-pink-600">Wall of Love</a>
      <a href="#about" class="nav-link hover:text-pink-600">About</a>
    </div>
    <div class="mobile-menu relative">
      <button id="mobileMenuButton" class="p-2">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <div id="mobileMenuDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
        <a href="#explore" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Explore</a>
        <a href="#share" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Share</a>
        <a href="#wall" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Wall of Love</a>
        <a href="#about" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">About</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <!-- Explore Memories Section -->
    <section id="explore" class="p-6 mb-12">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-images mr-3"></i> Explore Memories
      </h2>
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
        <div class="relative w-full md:w-64">
          <input type="text" id="searchInput" placeholder="Search memories..." class="w-full p-2 pl-10 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300">
          <i class="fas fa-search absolute left-3 top-3 text-pink-400"></i>
        </div>
        <div class="flex space-x-2">
          <button id="sortNewest" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Newest</button>
          <button id="sortOldest" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Oldest</button>
          <button id="sortPopular" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Popular</button>
        </div>
      </div>
      <div id="loadingMemories" class="flex justify-center items-center py-12">
        <div class="loading-spinner"></div>
      </div>
      <div id="memoryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Memory cards will be loaded here -->
      </div>
      <div id="noMemories" class="text-center py-12 hidden">
        <i class="fas fa-camera text-5xl text-pink-300 mb-4"></i>
        <h3 class="text-xl text-pink-700">No memories found</h3>
        <p class="text-pink-500">Be the first to share a memory!</p>
      </div>
    </section>

    <!-- Share Memory Section -->
    <section id="share" class="bg-white p-6 md:p-8 my-10 rounded-xl shadow-xl max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-plus-circle mr-3"></i> Share a Memory
      </h2>
      <form id="memoryForm" class="space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label for="name" class="block text-sm font-medium text-pink-700 mb-1">Your Name</label>
            <input id="name" type="text" placeholder="Enter your name" class="w-full p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
          </div>
          <div>
            <label for="batch" class="block text-sm font-medium text-pink-700 mb-1">Batch</label>
            <select id="batch" class="w-full p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300">
              <option value="">Select your batch</option>
              <option value="DS">DS</option>
              <option value="CS">CS</option>
              <option value="AIML">AIML</option>
              <option value="EEE">EEE</option>
              <option value="ECE">ECE</option>
              <option value="ME">ME</option>
              <option value="CE">CE</option>
              <option value="Hostel">Hostel</option>
            </select>
          </div>
        </div>
        <div>
          <label for="title" class="block text-sm font-medium text-pink-700 mb-1">Memory Title</label>
          <input id="title" type="text" placeholder="Give your memory a title" class="w-full p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
        </div>
        <div>
          <label for="desc" class="block text-sm font-medium text-pink-700 mb-1">Memory Description</label>
          <textarea id="desc" placeholder="Describe your memory in detail..." class="w-full p-3 border border-pink-200 rounded-lg h-32 focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required></textarea>
        </div>
        <div>
          <label for="image" class="block text-sm font-medium text-pink-700 mb-1">Upload Image</label>
          <div class="flex items-center justify-center w-full">
            <label for="image" class="flex flex-col items-center justify-center w-full h-64 border-2 border-pink-300 border-dashed rounded-lg cursor-pointer bg-pink-50 hover:bg-pink-100 transition">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="fas fa-cloud-upload-alt text-4xl text-pink-400 mb-3"></i>
                <p class="mb-2 text-sm text-pink-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                <p class="text-xs text-pink-400">PNG, JPG, GIF (MAX. 5MB)</p>
              </div>
              <input id="image" type="file" accept="image/*" class="hidden" required />
            </label>
          </div>
          <div id="imagePreview" class="mt-3 hidden">
            <p class="text-sm text-pink-700 mb-2">Preview:</p>
            <img id="previewImage" src="#" alt="Preview" class="max-h-40 rounded-lg border border-pink-200" />
          </div>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <div class="flex items-center">
            <input id="anonymous" type="checkbox" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500">
            <label for="anonymous" class="ml-2 text-sm text-pink-700">Post anonymously</label>
          </div>
          <button type="submit" id="submitBtn" class="bg-gradient-to-r from-pink-500 to-red-400 text-white px-8 py-3 rounded-lg hover:from-pink-600 hover:to-red-500 transition-all shadow-lg hover:shadow-xl flex items-center">
            <i class="fas fa-paper-plane mr-2"></i> Share Memory
          </button>
        </div>
      </form>
      <div id="formSuccess" class="hidden mt-4 p-4 bg-green-100 text-green-700 rounded-lg">
        <i class="fas fa-check-circle mr-2"></i> Your memory has been shared successfully!
      </div>
      <div id="formError" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg">
        <i class="fas fa-exclamation-circle mr-2"></i> <span id="errorMessage">There was an error submitting your memory.</span>
      </div>
    </section>

    <!-- Wall of Love Section -->
    <section id="wall" class="bg-pink-50 p-6 md:p-8 my-10 rounded-xl shadow-lg max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-heart mr-3"></i> Wall of Love
      </h2>
      <form id="loveNoteForm" class="mb-8">
        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
          <input id="loveNoteTo" type="text" placeholder="To (Name)" class="flex-1 p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
          <input id="loveNoteFrom" type="text" placeholder="From (Your Name)" class="flex-1 p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
        </div>
        <textarea id="loveNoteMessage" placeholder="Write your love note..." class="w-full p-3 border border-pink-200 rounded-lg h-24 mt-3 focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required></textarea>
        <button type="submit" class="mt-3 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition">
          <i class="fas fa-heart mr-2"></i> Post Love Note
        </button>
      </form>
      <div id="loveNotesContainer" class="space-y-4">
        <!-- Love notes will be loaded here -->
      </div>
    </section>

    <!-- About Section -->
    <section id="about" class="bg-white p-6 md:p-8 my-10 rounded-xl shadow-lg max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-info-circle mr-3"></i> About MACE Memories
      </h2>
      <div class="prose prose-pink max-w-none">
        <p class="text-gray-700">Welcome to <span class="text-pink-600 font-semibold">MACE Memories</span>, a digital scrapbook created to preserve the special moments from our college journey at Mar Athanasius College of Engineering.</p>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">Our Mission</h3>
        <p>College life is full of unforgettable moments - the laughter, the struggles, the friendships, and the growth. This platform is designed to help us capture and cherish these memories forever.</p>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">Features</h3>
        <ul class="list-disc pl-5 space-y-2">
          <li><span class="font-medium">Share Memories:</span> Upload photos and stories from campus life</li>
          <li><span class="font-medium">Wall of Love:</span> Send appreciation notes to your friends and faculty</li>
          <li><span class="font-medium">Relive Moments:</span> Browse through memories by batch or popularity</li>
          <li><span class="font-medium">Interactive:</span> Like and comment on memories</li>
        </ul>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">The Team</h3>
        <p>This project was created by <span class="text-pink-600 font-medium">Dathan</span> from the Computer Science department, batch of DS 28.</p>
        
        <div class="mt-8 p-4 bg-pink-50 rounded-lg border border-pink-200">
          <h4 class="text-lg text-pink-700 font-medium mb-2">Have feedback?</h4>
          <p>We'd love to hear from you! Email us at <a href="mailto:memories@mace.ac.in" class="text-pink-600 hover:underline">memories@mace.ac.in</a></p>
        </div>
      </div>
    </section>
  </main>

  <button id="backToTop" class="floating-btn bg-gradient-to-br from-pink-400 to-red-400 text-white hidden">
    <i class="fas fa-arrow-up text-xl"></i>
  </button>

  <footer class="text-center p-6 mt-12 text-sm text-gray-600 bg-white/80">
    <div class="flex justify-center space-x-4 mb-3">
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-facebook-f"></i></a>
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-instagram"></i></a>
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-twitter"></i></a>
    </div>
    <p>üéì Made with ‚ù§Ô∏è by Dathan | MACE Memories ¬© 2025</p>
    <p class="mt-1 text-xs text-gray-400">All memories belong to their respective contributors</p>
  </footer>

  <!-- Memory Modal -->
  <div id="memoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      <div class="sticky top-0 bg-white dark:bg-gray-800 p-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-bold text-pink-700 dark:text-pink-400"></h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6">
        <img id="modalImage" src="" alt="" class="w-full h-auto max-h-96 object-contain rounded-lg mb-4">
        <div class="flex justify-between items-center mb-4">
          <div>
            <p id="modalAuthor" class="text-pink-600 dark:text-pink-400 font-medium"></p>
            <p id="modalBatch" class="text-sm text-gray-500 dark:text-gray-400"></p>
          </div>
          <div class="flex items-center space-x-4">
            <button id="modalLikeBtn" class="like-btn text-gray-400 hover:text-pink-500 dark:hover:text-pink-400">
              <i class="far fa-heart"></i> <span id="likeCount">0</span>
            </button>
            <button id="modalCommentBtn" class="text-gray-400 hover:text-pink-500 dark:hover:text-pink-400">
              <i class="far fa-comment"></i> <span id="commentCount">0</span>
            </button>
          </div>
        </div>
        <p id="modalDescription" class="text-gray-700 dark:text-gray-300 mb-6"></p>
        <div class="border-t dark:border-gray-700 pt-4">
          <h4 class="font-medium text-pink-700 dark:text-pink-400 mb-3">Comments</h4>
          <div id="modalComments" class="space-y-3 mb-4">
            <!-- Comments will appear here -->
          </div>
          <form id="commentForm" class="flex">
            <input type="text" id="commentInput" placeholder="Add a comment..." class="flex-1 p-2 border border-pink-200 dark:border-gray-600 rounded-l-lg focus:ring-1 focus:ring-pink-300 dark:bg-gray-700 dark:text-white">
            <button type="submit" class="bg-pink-500 dark:bg-pink-600 text-white px-4 rounded-r-lg hover:bg-pink-600 dark:hover:bg-pink-700">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Firebase configuration (Firestore only)
    const firebaseConfig = {
      apiKey: "AIzaSyApTrNe1cay-7qvQl2E5vI1XD6VVa5g4s4",
      authDomain: "mace-memories.firebaseapp.com",
      projectId: "mace-memories",
      messagingSenderId: "570193691300",
      appId: "1:570193691300:web:0ce9c7f546d3c3a03e5c31"
    };

    // Initialize Firebase (only Firestore)
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // Cloudinary configuration - REPLACE WITH YOUR OWN
    const cloudName = "dazdmyujy"; // From Cloudinary dashboard
    const uploadPreset = "mace_memories"; // From Cloudinary settings

    // DOM elements
    const memoryForm = document.getElementById("memoryForm");
    const loveNoteForm = document.getElementById("loveNoteForm");
    const memoryGrid = document.getElementById("memoryGrid");
    const loadingMemories = document.getElementById("loadingMemories");
    const noMemories = document.getElementById("noMemories");
    const imageInput = document.getElementById("image");
    const imagePreview = document.getElementById("imagePreview");
    const previewImage = document.getElementById("previewImage");
    const backToTopBtn = document.getElementById("backToTop");
    const searchInput = document.getElementById("searchInput");
    const sortNewest = document.getElementById("sortNewest");
    const sortOldest = document.getElementById("sortOldest");
    const sortPopular = document.getElementById("sortPopular");
    const memoryModal = document.getElementById("memoryModal");
    const closeModal = document.getElementById("closeModal");
    const modalImage = document.getElementById("modalImage");
    const modalTitle = document.getElementById("modalTitle");
    const modalAuthor = document.getElementById("modalAuthor");
    const modalBatch = document.getElementById("modalBatch");
    const modalDescription = document.getElementById("modalDescription");
    const modalLikeBtn = document.getElementById("modalLikeBtn");
    const likeCount = document.getElementById("likeCount");
    const commentCount = document.getElementById("commentCount");
    const modalComments = document.getElementById("modalComments");
    const commentForm = document.getElementById("commentForm");
    const commentInput = document.getElementById("commentInput");
    const formSuccess = document.getElementById("formSuccess");
    const formError = document.getElementById("formError");
    const errorMessage = document.getElementById("errorMessage");
    const loveNotesContainer = document.getElementById("loveNotesContainer");
    const themeToggle = document.getElementById("themeToggle");
    const darkModeIcon = document.querySelector('.dark-mode-icon');
    const lightModeIcon = document.querySelector('.light-mode-icon');
    const mobileMenuButton = document.getElementById('mobileMenuButton');
    const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');

    // Current memory ID for modal
    let currentMemoryId = null;

    // Image preview handler
    imageInput.addEventListener("change", function() {
      const file = this.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          imagePreview.classList.remove("hidden");
        }
        reader.readAsDataURL(file);
      } else {
        imagePreview.classList.add("hidden");
      }
    });

    // Back to top button
    window.addEventListener("scroll", () => {
      if (window.pageYOffset > 300) {
        backToTopBtn.classList.remove("hidden");
      } else {
        backToTopBtn.classList.add("hidden");
      }
    });

    backToTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDarkMode = document.body.classList.contains('dark');
      localStorage.setItem('darkMode', isDarkMode);
      
      // Toggle icons
      if (isDarkMode) {
        darkModeIcon.classList.remove('hidden');
        lightModeIcon.classList.add('hidden');
      } else {
        darkModeIcon.classList.add('hidden');
        lightModeIcon.classList.remove('hidden');
      }
    });

    // Mobile menu toggle
    mobileMenuButton.addEventListener('click', () => {
      mobileMenuDropdown.classList.toggle('hidden');
    });

    // Close mobile menu when clicking outside
    document.addEventListener('click', (e) => {
      if (!mobileMenuButton.contains(e.target) && !mobileMenuDropdown.contains(e.target)) {
        mobileMenuDropdown.classList.add('hidden');
      }
    });

    // Check for saved theme preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      darkModeIcon.classList.remove('hidden');
      lightModeIcon.classList.add('hidden');
    } else {
      document.body.classList.remove('dark');
      darkModeIcon.classList.add('hidden');
      lightModeIcon.classList.remove('hidden');
    }

    // Memory form submission with Cloudinary
    memoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const submitBtn = document.getElementById("submitBtn");
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
      submitBtn.disabled = true;
      
      const name = document.getElementById("name").value;
      const title = document.getElementById("title").value;
      const desc = document.getElementById("desc").value;
      const batch = document.getElementById("batch").value;
      const anonymous = document.getElementById("anonymous").checked;
      const file = imageInput.files[0];
      
      if (!file) {
        showError("Please select an image");
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        return;
      }
      
      try {
        // Upload image to Cloudinary
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Image upload failed');
        }
        
        const data = await response.json();
        const imageUrl = data.secure_url;
        
        // Save memory data to Firestore
        await db.collection("memories").add({
          name: anonymous ? "Anonymous" : name,
          title,
          desc,
          batch,
          imageUrl: imageUrl,
          created: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          likesBy: [],
          comments: []
        });
        
        // Reset form and show success
        memoryForm.reset();
        imagePreview.classList.add("hidden");
        formSuccess.classList.remove("hidden");
        formError.classList.add("hidden");
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        
        // Hide success message after 5 seconds
        setTimeout(() => {
          formSuccess.classList.add("hidden");
        }, 5000);
        
        // Reload memories
        loadMemories();
      } catch (err) {
        showError("Error submitting memory: " + err.message);
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });

    // Love note form submission
    loveNoteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const to = document.getElementById("loveNoteTo").value;
      const from = document.getElementById("loveNoteFrom").value;
      const message = document.getElementById("loveNoteMessage").value;
      
      try {
        await db.collection("loveNotes").add({
          to,
          from,
          message,
          created: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          likesBy: []
        });
        
        loveNoteForm.reset();
        loadLoveNotes();
        
        // Show temporary success message
        const successMsg = document.createElement("div");
        successMsg.className = "fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg";
        successMsg.innerHTML = '<i class="fas fa-check mr-2"></i> Love note posted!';
        document.body.appendChild(successMsg);
        
        setTimeout(() => {
          successMsg.remove();
        }, 3000);
      } catch (err) {
        console.error("Error posting love note:", err);
        showError("Failed to post love note");
      }
    });

    // Load memories from Firestore
    async function loadMemories(query = null) {
      loadingMemories.classList.remove("hidden");
      memoryGrid.innerHTML = "";
      
      try {
        let memoriesQuery = query || db.collection("memories").orderBy("created", "desc");
        const snapshot = await memoriesQuery.get();
        
        if (snapshot.empty) {
          noMemories.classList.remove("hidden");
          loadingMemories.classList.add("hidden");
          return;
        }
        
        noMemories.classList.add("hidden");
        
        snapshot.forEach(doc => {
          const memory = doc.data();
          const memoryId = doc.id;
          
          const memoryCard = document.createElement("div");
          memoryCard.className = "bg-white memory-card shadow-lg rounded-xl overflow-hidden dark:bg-gray-800 dark:text-white";
          memoryCard.innerHTML = `
            <img src="${memory.imageUrl}" class="w-full h-60 object-cover cursor-pointer" alt="${memory.title}" />
            <div class="p-4">
              <h3 class="text-xl font-semibold text-pink-700 dark:text-pink-400 mb-1">${memory.title}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">by ${memory.name} ${memory.batch ? `¬∑ Batch ${memory.batch}` : ''}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-2">${memory.desc}</p>
              <div class="flex justify-between items-center mt-3 pt-3 border-t border-pink-100 dark:border-gray-700">
                <button class="text-pink-500 hover:text-pink-700 dark:hover:text-pink-400 text-sm font-medium view-memory" data-id="${memoryId}">
                  View Memory
                </button>
                <div class="flex items-center space-x-3">
                  <span class="text-xs text-pink-500 dark:text-pink-400 flex items-center">
                    <i class="far fa-heart mr-1"></i> ${memory.likes || 0}
                  </span>
                  <span class="text-xs text-pink-500 dark:text-pink-400 flex items-center">
                    <i class="far fa-comment mr-1"></i> ${memory.comments ? memory.comments.length : 0}
                  </span>
                </div>
              </div>
            </div>
          `;
          
          memoryGrid.appendChild(memoryCard);
        });
        
        // Add click event to view memory buttons
        document.querySelectorAll(".view-memory").forEach(btn => {
          btn.addEventListener("click", () => openMemoryModal(btn.dataset.id));
        });
        
      } catch (err) {
        console.error("Error loading memories:", err);
        showError("Failed to load memories");
      } finally {
        loadingMemories.classList.add("hidden");
      }
    }

    // Load love notes from Firestore
    async function loadLoveNotes() {
      loveNotesContainer.innerHTML = "";
      
      try {
        const snapshot = await db.collection("loveNotes").orderBy("created", "desc").limit(20).get();
        
        snapshot.forEach(doc => {
          const note = doc.data();
          const noteId = doc.id;
          const date = note.created ? note.created.toDate() : new Date();
          
          const noteElement = document.createElement("div");
          noteElement.className = "bg-white shadow-md p-5 rounded-xl border-l-4 border-pink-400 dark:bg-gray-800 dark:border-pink-600";
          noteElement.innerHTML = `
            <p class="text-pink-700 dark:text-pink-300"><strong class="text-pink-800 dark:text-pink-400">To ${note.to}:</strong> ${note.message} - <span class="font-medium">${note.from}</span></p>
            <div class="flex justify-between items-center mt-3">
              <span class="text-xs text-pink-500 dark:text-pink-400">${formatDate(date)}</span>
              <button class="like-btn text-gray-400 hover:text-pink-500 dark:hover:text-pink-400" data-id="${noteId}" data-likes="${note.likes || 0}">
                <i class="${note.likesBy && note.likesBy.includes(auth.currentUser?.uid) ? 'fas' : 'far'} fa-heart"></i> ${note.likes || 0}
              </button>
            </div>
          `;
          
          loveNotesContainer.appendChild(noteElement);
        });
        
        // Add like functionality to love notes
        document.querySelectorAll("#loveNotesContainer .like-btn").forEach(btn => {
          btn.addEventListener("click", () => likeLoveNote(btn.dataset.id));
        });
        
      } catch (err) {
        console.error("Error loading love notes:", err);
        showError("Failed to load love notes");
      }
    }

    // Open memory modal
    async function openMemoryModal(memoryId) {
      currentMemoryId = memoryId;
      
      try {
        const doc = await db.collection("memories").doc(memoryId).get();
        if (!doc.exists) {
          showError("Memory not found");
          return;
        }
        
        const memory = doc.data();
        
        // Set modal content
        modalImage.src = memory.imageUrl;
        modalTitle.textContent = memory.title;
        modalAuthor.textContent = `by ${memory.name} ${memory.batch ? `¬∑ Batch ${memory.batch}` : ''}`;
        modalBatch.textContent = memory.created ? formatDate(memory.created.toDate()) : '';
        modalDescription.textContent = memory.desc;
        likeCount.textContent = memory.likes || 0;
        commentCount.textContent = memory.comments ? memory.comments.length : 0;
        
        // Set like button state
        const isLiked = memory.likesBy && memory.likesBy.includes(auth.currentUser?.uid);
        modalLikeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${memory.likes || 0}`;
        modalLikeBtn.className = `like-btn ${isLiked ? 'liked' : ''}`;
        
        // Load comments
        modalComments.innerHTML = '';
        if (memory.comments && memory.comments.length > 0) {
          memory.comments.forEach(comment => {
            const commentElement = document.createElement("div");
            commentElement.className = "bg-pink-50 dark:bg-gray-700 p-3 rounded-lg";
            commentElement.innerHTML = `
              <p class="text-sm font-medium text-pink-700 dark:text-pink-300">${comment.author}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${comment.text}</p>
              <p class="text-xs text-pink-400 dark:text-pink-500 mt-1">${formatDate(comment.timestamp.toDate())}</p>
            `;
            modalComments.appendChild(commentElement);
          });
        } else {
          modalComments.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No comments yet</p>';
        }
        
        // Show modal
        memoryModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        
      } catch (err) {
        console.error("Error opening memory:", err);
        showError("Failed to load memory");
      }
    }

    // Close memory modal
    closeModal.addEventListener("click", () => {
      memoryModal.classList.add("hidden");
      document.body.style.overflow = "auto";
    });

    // Like memory
    modalLikeBtn.addEventListener("click", async () => {
      if (!auth.currentUser) {
        showError("Please sign in to like memories");
        return;
      }
      
      try {
        const memoryRef = db.collection("memories").doc(currentMemoryId);
        const doc = await memoryRef.get();
        const memory = doc.data();
        
        const isLiked = memory.likesBy && memory.likesBy.includes(auth.currentUser.uid);
        const newLikes = isLiked ? (memory.likes || 0) - 1 : (memory.likes || 0) + 1;
        const newLikesBy = isLiked 
          ? memory.likesBy.filter(id => id !== auth.currentUser.uid)
          : [...(memory.likesBy || []), auth.currentUser.uid];
        
        await memoryRef.update({
          likes: newLikes,
          likesBy: newLikesBy
        });
        
        // Update UI
        modalLikeBtn.innerHTML = `<i class="${!isLiked ? 'fas' : 'far'} fa-heart"></i> ${newLikes}`;
        modalLikeBtn.className = `like-btn ${!isLiked ? 'liked' : ''}`;
        likeCount.textContent = newLikes;
        
        // Update the memory card like count if it exists
        const memoryCardLike = document.querySelector(`.view-memory[data-id="${currentMemoryId}"]`)?.closest(".memory-card")?.querySelector(".fa-heart")?.closest("span");
        if (memoryCardLike) {
          memoryCardLike.innerHTML = `<i class="far fa-heart mr-1"></i> ${newLikes}`;
        }
        
      } catch (err) {
        console.error("Error liking memory:", err);
        showError("Failed to like memory");
      }
    });

    // Like love note
    async function likeLoveNote(noteId) {
      if (!auth.currentUser) {
        showError("Please sign in to like notes");
        return;
      }
      
      try {
        const noteRef = db.collection("loveNotes").doc(noteId);
        const doc = await noteRef.get();
        const note = doc.data();
        
        const isLiked = note.likesBy && note.likesBy.includes(auth.currentUser.uid);
        const newLikes = isLiked ? (note.likes || 0) - 1 : (note.likes || 0) + 1;
        const newLikesBy = isLiked 
          ? note.likesBy.filter(id => id !== auth.currentUser.uid)
          : [...(note.likesBy || []), auth.currentUser.uid];
        
        await noteRef.update({
          likes: newLikes,
          likesBy: newLikesBy
        });
        
        // Reload love notes to update UI
        loadLoveNotes();
        
      } catch (err) {
        console.error("Error liking love note:", err);
        showError("Failed to like note");
      }
    }

    // Add comment to memory
    commentForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!auth.currentUser) {
        showError("Please sign in to comment");
        return;
      }
      
      const commentText = commentInput.value.trim();
      if (!commentText) return;
      
      try {
        const memoryRef = db.collection("memories").doc(currentMemoryId);
        const newComment = {
          author: auth.currentUser.displayName || "Anonymous",
          text: commentText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await memoryRef.update({
          comments: firebase.firestore.FieldValue.arrayUnion(newComment)
        });
        
        // Add comment to UI
        const commentElement = document.createElement("div");
        commentElement.className = "bg-pink-50 dark:bg-gray-700 p-3 rounded-lg";
        commentElement.innerHTML = `
          <p class="text-sm font-medium text-pink-700 dark:text-pink-300">${newComment.author}</p>
          <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${newComment.text}</p>
          <p class="text-xs text-pink-400 dark:text-pink-500 mt-1">Just now</p>
        `;
        modalComments.prepend(commentElement);
        
        // Update comment count
        const currentCount = parseInt(commentCount.textContent);
        commentCount.textContent = currentCount + 1;
        
        // Update the memory card comment count if it exists
        const memoryCardComment = document.querySelector(`.view-memory[data-id="${currentMemoryId}"]`)?.closest(".memory-card")?.querySelector(".fa-comment")?.closest("span");
        if (memoryCardComment) {
          const currentCardCount = parseInt(memoryCardComment.textContent.trim());
          memoryCardComment.innerHTML = `<i class="far fa-comment mr-1"></i> ${currentCardCount + 1}`;
        }
        
        // Clear input
        commentInput.value = "";
        
      } catch (err) {
        console.error("Error adding comment:", err);
        showError("Failed to add comment");
      }
    });

    // Search functionality
    searchInput.addEventListener("input", (e) => {
      const searchTerm = e.target.value.toLowerCase();
      if (searchTerm.length > 2) {
        const query = db.collection("memories")
          .orderBy("title")
          .startAt(searchTerm)
          .endAt(searchTerm + '\uf8ff');
        loadMemories(query);
      } else if (searchTerm.length === 0) {
        loadMemories();
      }
    });

    // Sort functionality
    sortNewest.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("created", "desc"));
      sortNewest.classList.add("bg-pink-300");
      sortOldest.classList.remove("bg-pink-300");
      sortPopular.classList.remove("bg-pink-300");
    });

    sortOldest.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("created", "asc"));
      sortNewest.classList.remove("bg-pink-300");
      sortOldest.classList.add("bg-pink-300");
      sortPopular.classList.remove("bg-pink-300");
    });

    sortPopular.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("likes", "desc"));
      sortNewest.classList.remove("bg-pink-300");
      sortOldest.classList.remove("bg-pink-300");
      sortPopular.classList.add("bg-pink-300");
    });

    // Format date
    function formatDate(date) {
      const options = { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' };
      return date.toLocaleDateString('en-US', options);
    }

    // Show error message
    function showError(message) {
      errorMessage.textContent = message;
      formError.classList.remove("hidden");
      
      setTimeout(() => {
        formError.classList.add("hidden");
      }, 5000);
    }

    // Initialize
    function init() {
      // Load initial data
      loadMemories();
      loadLoveNotes();
      
      // Set default sort
      sortNewest.classList.add("bg-pink-300");
      
      // Anonymous sign-in
      auth.signInAnonymously()
        .then(() => {
          console.log("Signed in anonymously");
        })
        .catch(err => {
          console.error("Anonymous sign-in failed:", err);
        });
    }

    // Start the app
    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
