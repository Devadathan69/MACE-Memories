<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MACE Memories</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg, #fdf2f8 0%, #f0f9ff 100%);
      min-height: 100vh;
      transition: background-color 0.3s ease, color 0.3s ease;
    }
    body.dark {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
      color: #e2e8f0;
    }
    .pacifico {
      font-family: 'Pacifico', cursive;
    }
    .memory-card {
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    .memory-card:hover {
      transform: translateY(-5px) scale(1.02);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
    }
    .dark .memory-card {
      background-color: #2d3748;
      color: #e2e8f0;
    }
    .floating-btn {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
      z-index: 100;
      transition: all 0.3s ease;
    }
    .floating-btn:hover {
      transform: scale(1.1);
    }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top: 4px solid #ec4899;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
    .dark .loading-spinner {
      border-top-color: #f472b6;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .nav-link {
      position: relative;
    }
    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background-color: #ec4899;
      transition: width 0.3s ease;
    }
    .dark .nav-link::after {
      background-color: #f472b6;
    }
    .nav-link:hover::after {
      width: 100%;
    }
    .like-btn {
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .like-btn:hover {
      transform: scale(1.2);
    }
    .like-btn.liked {
      color: #ec4899 !important;
    }
    .dark .like-btn.liked {
      color: #f472b6 !important;
    }
    .comment-box {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    .comment-box.open {
      max-height: 500px;
    }
    /* Auth modal styles */
    .auth-modal {
      backdrop-filter: blur(10px);
    }
    .auth-tab {
      transition: all 0.3s ease;
      border-bottom: 2px solid transparent;
    }
    .auth-tab.active {
      border-bottom-color: #ec4899;
      color: #ec4899;
    }
    /* Profile dropdown styles */
    .profile-dropdown {
      transform: translateY(-10px);
      opacity: 0;
      transition: all 0.2s ease;
    }
    .profile-dropdown.show {
      transform: translateY(0);
      opacity: 1;
    }
    /* Notification styles */
    .notification {
      transform: translateX(100%);
      transition: transform 0.3s ease;
    }
    .notification.show {
      transform: translateX(0);
    }
    /* Badge styles */
    .badge {
      font-size: 0.7rem;
      padding: 2px 6px;
      border-radius: 10px;
    }
    /* Dark mode specific styles */
    .dark header {
      background: linear-gradient(to right, #4a044e, #2c3e50);
    }
    .dark .bg-white {
      background-color: #2d3748 !important;
      color: #e2e8f0;
    }
    .dark .text-gray-800 {
      color: #e2e8f0;
    }
    .dark .text-pink-700 {
      color: #f472b6;
    }
    .dark .text-pink-600 {
      color: #f9a8d4;
    }
    .dark .text-pink-500 {
      color: #f9a8d4;
    }
    .dark .bg-pink-50 {
      background-color: #4c1d95;
    }
    .dark .border-pink-200 {
      border-color: #5b21b6;
    }
    .dark .bg-gradient-to-r.from-pink-500.to-red-400 {
      background: linear-gradient(to right, #9d174d, #831843);
    }
    .dark .bg-pink-100 {
      background-color: #5b21b6;
      color: white;
    }
    .dark .bg-pink-600 {
      background-color: #9d174d;
    }
    .dark .border-pink-100 {
      border-color: #5b21b6;
    }
    .dark .text-gray-600 {
      color: #cbd5e0;
    }
    .dark .text-gray-500 {
      color: #a0aec0;
    }
    .dark .text-gray-700 {
      color: #e2e8f0;
    }
    .dark .bg-white\/80 {
      background-color: rgba(45, 55, 72, 0.8);
    }
    .dark .bg-pink-400 {
      background-color: #9d174d;
    }
    .dark .text-pink-900 {
      color: #f9a8d4;
    }
    .dark .text-pink-800 {
      color: #f9a8d4;
    }
    .dark .bg-pink-300 {
      background-color: #9d174d;
    }
    .dark .bg-red-100 {
      background-color: #7f1d1d;
    }
    .dark .bg-green-100 {
      background-color: #065f46;
    }
    .dark .text-green-700 {
      color: #6ee7b7;
    }
    .dark .bg-red-100 {
      background-color: #7f1d1d;
    }
    .dark .text-red-700 {
      color: #fca5a5;
    }
    /* Mobile menu */
    .mobile-menu {
      display: none;
    }
    @media (max-width: 768px) {
      .mobile-menu {
        display: block;
      }
      .desktop-menu {
        display: none;
      }
      .memory-card {
        max-width: 100%;
      }
      #memoryGrid {
        grid-template-columns: 1fr;
      }
      .floating-btn {
        width: 50px;
        height: 50px;
        bottom: 1rem;
        right: 1rem;
      }
      header h1 {
        font-size: 2.5rem;
      }
      header p {
        font-size: 0.9rem;
      }
      .love-note-form {
        flex-direction: column;
      }
      .love-note-form input {
        width: 100%;
        margin-bottom: 0.5rem;
      }
    }
  </style>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>

<body class="text-gray-800">
  <!-- Header and navigation -->
  <header class="bg-gradient-to-r from-pink-400 via-red-300 to-yellow-200 p-6 shadow-lg relative overflow-hidden">
    <div class="absolute inset-0 bg-white opacity-10"></div>
    <div class="relative z-10">
      <div class="flex justify-between items-center">
        <div>
          <h1 class="text-5xl md:text-6xl pacifico text-center text-pink-900 drop-shadow-lg">MACE Memories</h1>
          <p class="text-center text-lg mt-2 italic text-pink-800 font-medium">Preserving the chaos, laughter, and love of our college journey</p>
        </div>
        <div class="flex items-center space-x-4">
          <!-- User Profile Section -->
          <div id="userSection" class="hidden">
            <div class="relative">
              <button id="profileButton" class="flex items-center space-x-2 bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full transition">
                <img id="userAvatar" src="" alt="Avatar" class="w-8 h-8 rounded-full">
                <span id="userName" class="text-pink-900 font-medium hidden md:block"></span>
                <i class="fas fa-chevron-down text-pink-900"></i>
              </button>
              <div id="profileDropdown" class="profile-dropdown absolute right-0 mt-2 w-64 bg-white dark:bg-gray-800 rounded-lg shadow-lg py-2 z-50 hidden">
                <div class="px-4 py-2 border-b dark:border-gray-700">
                  <p class="font-medium text-gray-800 dark:text-white" id="dropdownUserName"></p>
                  <p class="text-sm text-gray-500 dark:text-gray-400" id="dropdownUserBatch"></p>
                </div>
                <a href="#profile" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-pink-100 dark:hover:bg-gray-700">
                  <i class="fas fa-user mr-2"></i> My Profile
                </a>
                <a href="#my-memories" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-pink-100 dark:hover:bg-gray-700">
                  <i class="fas fa-images mr-2"></i> My Memories
                </a>
                <a href="#settings" class="block px-4 py-2 text-sm text-gray-700 dark:text-gray-300 hover:bg-pink-100 dark:hover:bg-gray-700">
                  <i class="fas fa-cog mr-2"></i> Settings
                </a>
                <div class="border-t dark:border-gray-700 mt-2 pt-2">
                  <button id="signOutBtn" class="block w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-100 dark:hover:bg-red-900">
                    <i class="fas fa-sign-out-alt mr-2"></i> Sign Out
                  </button>
                </div>
              </div>
            </div>
          </div>
          <!-- Auth Buttons for non-logged in users -->
          <div id="authSection">
            <button id="loginBtn" class="bg-white/30 hover:bg-white/50 px-4 py-2 rounded-full text-pink-900 font-medium transition">
              Login
            </button>
          </div>
          <!-- Theme Toggle -->
          <button id="themeToggle" class="p-2 rounded-full bg-white/30 hover:bg-white/50 transition">
            <i class="fas fa-moon text-xl text-gray-800 dark-mode-icon hidden"></i>
            <i class="fas fa-sun text-xl text-yellow-500 light-mode-icon"></i>
          </button>
        </div>
      </div>
    </div>
    <div class="absolute bottom-0 left-0 right-0 h-2 bg-gradient-to-r from-pink-500 via-red-400 to-yellow-300"></div>
  </header>

  <nav class="flex justify-center space-x-6 md:space-x-10 mt-4 text-pink-700 font-semibold text-lg py-4 bg-white/80 backdrop-blur-sm sticky top-0 z-50 shadow-sm">
    <div class="desktop-menu flex space-x-6 md:space-x-10">
      <a href="#explore" class="nav-link hover:text-pink-600">Explore</a>
      <a href="#share" class="nav-link hover:text-pink-600">Share</a>
      <a href="#wall" class="nav-link hover:text-pink-600">Wall of Love</a>
      <a href="#about" class="nav-link hover:text-pink-600">About</a>
    </div>
    <div class="mobile-menu relative">
      <button id="mobileMenuButton" class="p-2">
        <i class="fas fa-bars text-xl"></i>
      </button>
      <div id="mobileMenuDropdown" class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
        <a href="#explore" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Explore</a>
        <a href="#share" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Share</a>
        <a href="#wall" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">Wall of Love</a>
        <a href="#about" class="block px-4 py-2 text-sm text-gray-700 hover:bg-pink-100">About</a>
      </div>
    </div>
  </nav>

  <main class="container mx-auto px-4 py-8">
    <!-- Explore Memories Section -->
    <section id="explore" class="p-6 mb-12">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-images mr-3"></i> Explore Memories
      </h2>
      <div class="flex flex-col md:flex-row justify-between items-center mb-6 space-y-4 md:space-y-0">
        <div class="relative w-full md:w-64">
          <input type="text" id="searchInput" placeholder="Search memories..." class="w-full p-2 pl-10 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300">
          <i class="fas fa-search absolute left-3 top-3 text-pink-400"></i>
        </div>
        <div class="flex space-x-2">
          <button id="sortNewest" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Newest</button>
          <button id="sortOldest" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Oldest</button>
          <button id="sortPopular" class="bg-pink-100 text-pink-700 px-3 py-1 rounded-lg hover:bg-pink-200 active:bg-pink-300">Popular</button>
        </div>
      </div>
      <div id="loadingMemories" class="flex justify-center items-center py-12">
        <div class="loading-spinner"></div>
      </div>
      <div id="memoryGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
        <!-- Memory cards will be loaded here -->
      </div>
      <div id="noMemories" class="text-center py-12 hidden">
        <i class="fas fa-camera text-5xl text-pink-300 mb-4"></i>
        <h3 class="text-xl text-pink-700">No memories found</h3>
        <p class="text-pink-500">Be the first to share a memory!</p>
      </div>
    </section>

    <!-- Share Memory Section -->
    <section id="share" class="bg-white p-6 md:p-8 my-10 rounded-xl shadow-xl max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-plus-circle mr-3"></i> Share a Memory
      </h2>
      <div id="loginPrompt" class="text-center py-8 hidden">
        <i class="fas fa-lock text-4xl text-pink-300 mb-4"></i>
        <h3 class="text-xl text-pink-700 mb-2">Please Login to Share Memories</h3>
        <p class="text-pink-500 mb-4">You need to be logged in to share your college memories</p>
        <button id="loginPromptBtn" class="bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition">
          Login / Sign Up
        </button>
      </div>
      <form id="memoryForm" class="space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label for="title" class="block text-sm font-medium text-pink-700 mb-1">Memory Title</label>
            <input id="title" type="text" placeholder="Give your memory a title" class="w-full p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
          </div>
          <div>
            <label for="category" class="block text-sm font-medium text-pink-700 mb-1">Category</label>
            <select id="category" class="w-full p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300">
              <option value="">Select category</option>
              <option value="campus">Campus Life</option>
              <option value="events">Events</option>
              <option value="friendship">Friendship</option>
              <option value="academics">Academics</option>
              <option value="hostel">Hostel Life</option>
              <option value="faculty">Faculty</option>
              <option value="sports">Sports</option>
              <option value="cultural">Cultural</option>
              <option value="graduation">Graduation</option>
              <option value="other">Other</option>
            </select>
          </div>
        </div>
        <div>
          <label for="desc" class="block text-sm font-medium text-pink-700 mb-1">Memory Description</label>
          <textarea id="desc" placeholder="Describe your memory in detail..." class="w-full p-3 border border-pink-200 rounded-lg h-32 focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required></textarea>
        </div>
        <div>
          <label for="image" class="block text-sm font-medium text-pink-700 mb-1">Upload Image</label>
          <div class="flex items-center justify-center w-full">
            <label for="image" class="flex flex-col items-center justify-center w-full h-64 border-2 border-pink-300 border-dashed rounded-lg cursor-pointer bg-pink-50 hover:bg-pink-100 transition">
              <div class="flex flex-col items-center justify-center pt-5 pb-6">
                <i class="fas fa-cloud-upload-alt text-4xl text-pink-400 mb-3"></i>
                <p class="mb-2 text-sm text-pink-500"><span class="font-semibold">Click to upload</span> or drag and drop</p>
                <p class="text-xs text-pink-400">PNG, JPG, GIF (MAX. 5MB)</p>
              </div>
              <input id="image" type="file" accept="image/*" class="hidden" required />
            </label>
          </div>
          <div id="imagePreview" class="mt-3 hidden">
            <p class="text-sm text-pink-700 mb-2">Preview:</p>
            <img id="previewImage" src="#" alt="Preview" class="max-h-40 rounded-lg border border-pink-200" />
          </div>
        </div>
        <div class="flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
          <div class="flex items-center space-x-4">
            <div class="flex items-center">
              <input id="anonymous" type="checkbox" class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500">
              <label for="anonymous" class="ml-2 text-sm text-pink-700">Post anonymously</label>
            </div>
            <div class="flex items-center">
              <input id="allowComments" type="checkbox" checked class="w-4 h-4 text-pink-600 rounded focus:ring-pink-500">
              <label for="allowComments" class="ml-2 text-sm text-pink-700">Allow comments</label>
            </div>
          </div>
          <button type="submit" id="submitBtn" class="bg-gradient-to-r from-pink-500 to-red-400 text-white px-8 py-3 rounded-lg hover:from-pink-600 hover:to-red-500 transition-all shadow-lg hover:shadow-xl flex items-center">
            <i class="fas fa-paper-plane mr-2"></i> Share Memory
          </button>
        </div>
      </form>
      <div id="formSuccess" class="hidden mt-4 p-4 bg-green-100 text-green-700 rounded-lg">
        <i class="fas fa-check-circle mr-2"></i> Your memory has been shared successfully!
      </div>
      <div id="formError" class="hidden mt-4 p-4 bg-red-100 text-red-700 rounded-lg">
        <i class="fas fa-exclamation-circle mr-2"></i> <span id="errorMessage">There was an error submitting your memory.</span>
      </div>
    </section>

    <!-- Wall of Love Section -->
    <section id="wall" class="bg-pink-50 p-6 md:p-8 my-10 rounded-xl shadow-lg max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-heart mr-3"></i> Wall of Love
      </h2>
      <form id="loveNoteForm" class="mb-8">
        <div class="flex flex-col md:flex-row space-y-3 md:space-y-0 md:space-x-3">
          <input id="loveNoteTo" type="text" placeholder="To (Name)" class="flex-1 p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
          <input id="loveNoteFrom" type="text" placeholder="From (Your Name)" class="flex-1 p-3 border border-pink-200 rounded-lg focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required />
        </div>
        <textarea id="loveNoteMessage" placeholder="Write your love note..." class="w-full p-3 border border-pink-200 rounded-lg h-24 mt-3 focus:ring-2 focus:ring-pink-300 focus:border-pink-300" required></textarea>
        <button type="submit" class="mt-3 bg-pink-600 text-white px-6 py-2 rounded-lg hover:bg-pink-700 transition">
          <i class="fas fa-heart mr-2"></i> Post Love Note
        </button>
      </form>
      <div id="loveNotesContainer" class="space-y-4">
        <!-- Love notes will be loaded here -->
      </div>
    </section>

    <!-- About Section -->
    <section id="about" class="bg-white p-6 md:p-8 my-10 rounded-xl shadow-lg max-w-4xl mx-auto">
      <h2 class="text-3xl font-bold mb-6 text-pink-700 flex items-center">
        <i class="fas fa-info-circle mr-3"></i> About MACE Memories
      </h2>
      <div class="prose prose-pink max-w-none">
        <p class="text-gray-700">Welcome to <span class="text-pink-600 font-semibold">MACE Memories</span>, a digital scrapbook created to preserve the special moments from our college journey at Mar Athanasius College of Engineering.</p>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">Our Mission</h3>
        <p>College life is full of unforgettable moments - the laughter, the struggles, the friendships, and the growth. This platform is designed to help us capture and cherish these memories forever.</p>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">New Features</h3>
        <ul class="list-disc pl-5 space-y-2">
          <li><span class="font-medium">User Profiles:</span> Create your personalized profile with avatar</li>
          <li><span class="font-medium">Enhanced Security:</span> Proper login/signup system</li>
          <li><span class="font-medium">Better Interactions:</span> Fixed like and comment system</li>
          <li><span class="font-medium">Categories:</span> Organize memories by type</li>
          <li><span class="font-medium">Real-time Updates:</span> See new content instantly</li>
        </ul>
        
        <h3 class="text-xl text-pink-700 mt-6 mb-3">The Team</h3>
        <p>This project was created by <span class="text-pink-600 font-medium">Dathan</span> from the Computer Science department, batch of DS 28.</p>
        
        <div class="mt-8 p-4 bg-pink-50 rounded-lg border border-pink-200">
          <h4 class="text-lg text-pink-700 font-medium mb-2">Have feedback?</h4>
          <p>We'd love to hear from you! Email us at <a href="mailto:memories@mace.ac.in" class="text-pink-600 hover:underline">memories@mace.ac.in</a></p>
        </div>
      </div>
    </section>
  </main>

  <button id="backToTop" class="floating-btn bg-gradient-to-br from-pink-400 to-red-400 text-white hidden">
    <i class="fas fa-arrow-up text-xl"></i>
  </button>

  <!-- Authentication Modal -->
  <div id="authModal" class="auth-modal fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full">
      <div class="p-6">
        <div class="flex justify-between items-center mb-6">
          <h2 class="text-2xl font-bold text-pink-700 dark:text-pink-400">Welcome to MACE</h2>
          <button id="closeAuthModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300">
            <i class="fas fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- Auth Tabs -->
        <div class="flex mb-6">
          <button id="loginTab" class="auth-tab flex-1 py-2 text-center font-medium active">Login</button>
          <button id="signupTab" class="auth-tab flex-1 py-2 text-center font-medium">Sign Up</button>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
            <input type="email" id="loginEmail" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="your.email@mace.ac.in">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
            <input type="password" id="loginPassword" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="Enter your password">
          </div>
          <button type="submit" class="w-full bg-pink-600 text-white py-3 rounded-lg hover:bg-pink-700 transition font-medium">
            <i class="fas fa-sign-in-alt mr-2"></i> Login
          </button>
          <div class="text-center">
            <button type="button" id="forgotPasswordBtn" class="text-pink-600 hover:text-pink-700 text-sm">Forgot Password?</button>
          </div>
        </form>

        <!-- Signup Form -->
        <form id="signupForm" class="space-y-4 hidden">
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">First Name</label>
              <input type="text" id="signupFirstName" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="John">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Last Name</label>
              <input type="text" id="signupLastName" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="Doe">
            </div>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Email</label>
            <input type="email" id="signupEmail" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="your.email@mace.ac.in">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Batch</label>
            <select id="signupBatch" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white">
              <option value="">Select your batch</option>
              <option value="DS">DS</option>
              <option value="CS">CS</option>
              <option value="AIML">AIML</option>
              <option value="EEE">EEE</option>
              <option value="ECE">ECE</option>
              <option value="ME">ME</option>
              <option value="CE">CE</option>
              <option value="Hostel">Hostel</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Password</label>
            <input type="password" id="signupPassword" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="Create a strong password">
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Confirm Password</label>
            <input type="password" id="signupConfirmPassword" required class="w-full p-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-pink-500 dark:bg-gray-700 dark:text-white" placeholder="Confirm your password">
          </div>
          <button type="submit" class="w-full bg-pink-600 text-white py-3 rounded-lg hover:bg-pink-700 transition font-medium">
            <i class="fas fa-user-plus mr-2"></i> Create Account
          </button>
        </form>

        <div id="authError" class="hidden mt-4 p-3 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 rounded-lg text-sm">
          <i class="fas fa-exclamation-circle mr-2"></i>
          <span id="authErrorMessage"></span>
        </div>
        
        <div id="authSuccess" class="hidden mt-4 p-3 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 rounded-lg text-sm">
          <i class="fas fa-check-circle mr-2"></i>
          <span id="authSuccessMessage"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Memory Modal -->
  <div id="memoryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 hidden">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto dark:bg-gray-800">
      <div class="sticky top-0 bg-white dark:bg-gray-800 p-4 border-b dark:border-gray-700 flex justify-between items-center">
        <h3 id="modalTitle" class="text-xl font-bold text-pink-700 dark:text-pink-400"></h3>
        <button id="closeModal" class="text-gray-500 hover:text-gray-700 dark:text-gray-300 dark:hover:text-white">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-6">
        <img id="modalImage" src="" alt="" class="w-full h-auto max-h-96 object-contain rounded-lg mb-4">
        <div class="flex justify-between items-center mb-4">
          <div>
            <p id="modalAuthor" class="text-pink-600 dark:text-pink-400 font-medium"></p>
            <p id="modalBatch" class="text-sm text-gray-500 dark:text-gray-400"></p>
            <p id="modalDate" class="text-xs text-gray-400 dark:text-gray-500"></p>
          </div>
          <div class="flex items-center space-x-4">
            <button id="modalLikeBtn" class="like-btn text-gray-400 hover:text-pink-500 dark:hover:text-pink-400">
              <i class="far fa-heart"></i> <span id="modalLikeCount">0</span>
            </button>
            <button id="modalCommentBtn" class="text-gray-400 hover:text-pink-500 dark:hover:text-pink-400">
              <i class="far fa-comment"></i> <span id="modalCommentCount">0</span>
            </button>
            <button id="modalShareBtn" class="text-gray-400 hover:text-pink-500 dark:hover:text-pink-400">
              <i class="fas fa-share"></i>
            </button>
          </div>
        </div>
        <p id="modalDescription" class="text-gray-700 dark:text-gray-300 mb-6"></p>
        <div id="modalCommentsSection" class="border-t dark:border-gray-700 pt-4">
          <h4 class="font-medium text-pink-700 dark:text-pink-400 mb-3">Comments</h4>
          <div id="modalComments" class="space-y-3 mb-4 max-h-60 overflow-y-auto">
            <!-- Comments will appear here -->
          </div>
          <form id="commentForm" class="flex">
            <input type="text" id="commentInput" placeholder="Add a comment..." class="flex-1 p-2 border border-pink-200 dark:border-gray-600 rounded-l-lg focus:ring-1 focus:ring-pink-300 dark:bg-gray-700 dark:text-white">
            <button type="submit" class="bg-pink-500 dark:bg-pink-600 text-white px-4 rounded-r-lg hover:bg-pink-600 dark:hover:bg-pink-700">
              <i class="fas fa-paper-plane"></i>
            </button>
          </form>
          <div id="loginToComment" class="hidden text-center py-4">
            <p class="text-gray-500 dark:text-gray-400 mb-2">Please login to comment</p>
            <button class="text-pink-600 hover:text-pink-700 text-sm font-medium">Login</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Notification Container -->
  <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-2">
    <!-- Notifications will appear here -->
  </div>

  <footer class="text-center p-6 mt-12 text-sm text-gray-600 bg-white/80">
    <div class="flex justify-center space-x-4 mb-3">
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-facebook-f"></i></a>
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-instagram"></i></a>
      <a href="#" class="text-pink-500 hover:text-pink-700"><i class="fab fa-twitter"></i></a>
    </div>
    <p>🎓 Made with ❤️ by Dathan | MACE Memories © 2025</p>
    <p class="mt-1 text-xs text-gray-400">All memories belong to their respective contributors</p>
  </footer>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyApTrNe1cay-7qvQl2E5vI1XD6VVa5g4s4",
      authDomain: "mace-memories.firebaseapp.com",
      projectId: "mace-memories",
      messagingSenderId: "570193691300",
      appId: "1:570193691300:web:0ce9c7f546d3c3a03e5c31"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const storage = firebase.storage();

    // Cloudinary configuration
    const cloudName = "dazdmyujy";
    const uploadPreset = "mace_memories";

    // DOM elements
    const memoryForm = document.getElementById("memoryForm");
    const loveNoteForm = document.getElementById("loveNoteForm");
    const memoryGrid = document.getElementById("memoryGrid");
    const loadingMemories = document.getElementById("loadingMemories");
    const noMemories = document.getElementById("noMemories");
    const imageInput = document.getElementById("image");
    const imagePreview = document.getElementById("imagePreview");
    const previewImage = document.getElementById("previewImage");
    const backToTopBtn = document.getElementById("backToTop");
    const searchInput = document.getElementById("searchInput");
    const sortNewest = document.getElementById("sortNewest");
    const sortOldest = document.getElementById("sortOldest");
    const sortPopular = document.getElementById("sortPopular");
    const memoryModal = document.getElementById("memoryModal");
    const closeModal = document.getElementById("closeModal");
    const authModal = document.getElementById("authModal");
    const closeAuthModal = document.getElementById("closeAuthModal");
    const loginBtn = document.getElementById("loginBtn");
    const loginPromptBtn = document.getElementById("loginPromptBtn");
    const loginTab = document.getElementById("loginTab");
    const signupTab = document.getElementById("signupTab");
    const loginForm = document.getElementById("loginForm");
    const signupForm = document.getElementById("signupForm");
    const userSection = document.getElementById("userSection");
    const authSection = document.getElementById("authSection");
    const profileButton = document.getElementById("profileButton");
    const profileDropdown = document.getElementById("profileDropdown");
    const signOutBtn = document.getElementById("signOutBtn");
    const loginPrompt = document.getElementById("loginPrompt");
    const themeToggle = document.getElementById("themeToggle");
    const darkModeIcon = document.querySelector('.dark-mode-icon');
    const lightModeIcon = document.querySelector('.light-mode-icon');
    const mobileMenuButton = document.getElementById('mobileMenuButton');
    const mobileMenuDropdown = document.getElementById('mobileMenuDropdown');

    // Global variables
    let currentUser = null;
    let currentMemoryId = null;
    let memoriesListener = null;

    // Initialize auth state listener
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateUIForAuthState(user);
      
      if (user && !user.isAnonymous) {
        // Load or create user profile
        loadUserProfile(user);
      }
    });

    // Update UI based on authentication state
    function updateUIForAuthState(user) {
      if (user && !user.isAnonymous) {
        userSection.classList.remove('hidden');
        authSection.classList.add('hidden');
        memoryForm.classList.remove('hidden');
        loginPrompt.classList.add('hidden');
      } else {
        userSection.classList.add('hidden');
        authSection.classList.remove('hidden');
        memoryForm.classList.add('hidden');
        loginPrompt.classList.remove('hidden');
      }
    }

    // Load user profile
    async function loadUserProfile(user) {
      try {
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          const userData = userDoc.data();
          document.getElementById('userName').textContent = userData.firstName;
          document.getElementById('dropdownUserName').textContent = `${userData.firstName} ${userData.lastName}`;
          document.getElementById('dropdownUserBatch').textContent = `Batch: ${userData.batch}`;
          
          // Set avatar
          const avatar = userData.avatar || `https://ui-avatars.com/api/?name=${userData.firstName}+${userData.lastName}&background=ec4899&color=fff`;
          document.getElementById('userAvatar').src = avatar;
        }
      } catch (error) {
        console.error('Error loading user profile:', error);
      }
    }

    // Show notification
    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification bg-white dark:bg-gray-800 border-l-4 ${type === 'success' ? 'border-green-500' : type === 'error' ? 'border-red-500' : 'border-blue-500'} p-4 rounded-lg shadow-lg max-w-sm`;
      
      notification.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${type === 'success' ? 'fa-check-circle text-green-500' : type === 'error' ? 'fa-exclamation-circle text-red-500' : 'fa-info-circle text-blue-500'} mr-2"></i>
          <span class="text-sm text-gray-700 dark:text-gray-300">${message}</span>
          <button class="ml-auto text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.getElementById('notificationContainer').appendChild(notification);
      
      // Auto remove after 5 seconds
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 5000);
      
      // Show animation
      setTimeout(() => {
        notification.classList.add('show');
      }, 100);
    }

    // Authentication functions
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      try {
        await auth.signInWithEmailAndPassword(email, password);
        authModal.classList.add('hidden');
        showNotification('Welcome back!', 'success');
      } catch (error) {
        showAuthError(error.message);
      }
    });

    signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const firstName = document.getElementById('signupFirstName').value;
      const lastName = document.getElementById('signupLastName').value;
      const email = document.getElementById('signupEmail').value;
      const batch = document.getElementById('signupBatch').value;
      const password = document.getElementById('signupPassword').value;
      const confirmPassword = document.getElementById('signupConfirmPassword').value;
      
      if (password !== confirmPassword) {
        showAuthError('Passwords do not match');
        return;
      }
      
      if (password.length < 6) {
        showAuthError('Password must be at least 6 characters');
        return;
      }
      
      try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const user = userCredential.user;
        
        // Create user profile in Firestore
        await db.collection('users').doc(user.uid).set({
          firstName,
          lastName,
          email,
          batch,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          avatar: `https://ui-avatars.com/api/?name=${firstName}+${lastName}&background=ec4899&color=fff`,
          memoriesCount: 0,
          likesCount: 0
        });
        
        // Update display name
        await user.updateProfile({
          displayName: `${firstName} ${lastName}`
        });
        
        authModal.classList.add('hidden');
        showNotification('Account created successfully!', 'success');
      } catch (error) {
        showAuthError(error.message);
      }
    });

    function showAuthError(message) {
      document.getElementById('authErrorMessage').textContent = message;
      document.getElementById('authError').classList.remove('hidden');
      document.getElementById('authSuccess').classList.add('hidden');
    }

    // Auth modal controls
    loginBtn.addEventListener('click', () => {
      authModal.classList.remove('hidden');
    });

    loginPromptBtn.addEventListener('click', () => {
      authModal.classList.remove('hidden');
    });

    closeAuthModal.addEventListener('click', () => {
      authModal.classList.add('hidden');
    });

    loginTab.addEventListener('click', () => {
      loginTab.classList.add('active');
      signupTab.classList.remove('active');
      loginForm.classList.remove('hidden');
      signupForm.classList.add('hidden');
    });

    signupTab.addEventListener('click', () => {
      signupTab.classList.add('active');
      loginTab.classList.remove('active');
      signupForm.classList.remove('hidden');
      loginForm.classList.add('hidden');
    });

    // Profile dropdown
    profileButton.addEventListener('click', () => {
      profileDropdown.classList.toggle('hidden');
      profileDropdown.classList.toggle('show');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      if (!profileButton.contains(e.target) && !profileDropdown.contains(e.target)) {
        profileDropdown.classList.add('hidden');
        profileDropdown.classList.remove('show');
      }
    });

    // Sign out
    signOutBtn.addEventListener('click', async () => {
      try {
        await auth.signOut();
        showNotification('Signed out successfully', 'success');
      } catch (error) {
        showNotification('Error signing out', 'error');
      }
    });

    // Image preview handler
    imageInput.addEventListener("change", function() {
      const file = this.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) { // 5MB limit
          showNotification('Image size must be less than 5MB', 'error');
          this.value = '';
          return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImage.src = e.target.result;
          imagePreview.classList.remove("hidden");
        }
        reader.readAsDataURL(file);
      } else {
        imagePreview.classList.add("hidden");
      }
    });

    // Back to top button
    window.addEventListener("scroll", () => {
      if (window.pageYOffset > 300) {
        backToTopBtn.classList.remove("hidden");
      } else {
        backToTopBtn.classList.add("hidden");
      }
    });

    backToTopBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: "smooth" });
    });

    // Theme toggle functionality
    themeToggle.addEventListener('click', () => {
      document.body.classList.toggle('dark');
      const isDarkMode = document.body.classList.contains('dark');
      localStorage.setItem('darkMode', isDarkMode);
      
      if (isDarkMode) {
        darkModeIcon.classList.remove('hidden');
        lightModeIcon.classList.add('hidden');
      } else {
        darkModeIcon.classList.add('hidden');
        lightModeIcon.classList.remove('hidden');
      }
    });

    // Mobile menu toggle
    mobileMenuButton.addEventListener('click', () => {
      mobileMenuDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!mobileMenuButton.contains(e.target) && !mobileMenuDropdown.contains(e.target)) {
        mobileMenuDropdown.classList.add('hidden');
      }
    });

    // Check for saved theme preference
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
      darkModeIcon.classList.remove('hidden');
      lightModeIcon.classList.add('hidden');
    }

    // Memory form submission
    memoryForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!currentUser || currentUser.isAnonymous) {
        showNotification('Please login to share memories', 'error');
        return;
      }
      
      const submitBtn = document.getElementById("submitBtn");
      const originalBtnText = submitBtn.innerHTML;
      submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Uploading...';
      submitBtn.disabled = true;
      
      const title = document.getElementById("title").value;
      const desc = document.getElementById("desc").value;
      const category = document.getElementById("category").value;
      const anonymous = document.getElementById("anonymous").checked;
      const allowComments = document.getElementById("allowComments").checked;
      const file = imageInput.files[0];
      
      if (!file) {
        showNotification("Please select an image", 'error');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        return;
      }
      
      try {
        // Upload image to Cloudinary
        const formData = new FormData();
        formData.append('file', file);
        formData.append('upload_preset', uploadPreset);
        
        const response = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
          method: 'POST',
          body: formData
        });
        
        if (!response.ok) {
          throw new Error('Image upload failed');
        }
        
        const data = await response.json();
        const imageUrl = data.secure_url;
        
        // Get user data
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        // Save memory data to Firestore
        const memoryData = {
          title,
          desc,
          category: category || 'other',
          imageUrl: imageUrl,
          authorId: currentUser.uid,
          authorName: anonymous ? "Anonymous" : `${userData.firstName} ${userData.lastName}`,
          authorBatch: anonymous ? "" : userData.batch,
          anonymous: anonymous,
          allowComments: allowComments,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          likesBy: [],
          comments: [],
          views: 0
        };
        
        await db.collection("memories").add(memoryData);
        
        // Update user's memory count
        await db.collection('users').doc(currentUser.uid).update({
          memoriesCount: firebase.firestore.FieldValue.increment(1)
        });
        
        // Reset form and show success
        memoryForm.reset();
        imagePreview.classList.add("hidden");
        showNotification('Memory shared successfully!', 'success');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
        
      } catch (err) {
        console.error("Error submitting memory:", err);
        showNotification("Error submitting memory: " + err.message, 'error');
        submitBtn.innerHTML = originalBtnText;
        submitBtn.disabled = false;
      }
    });

    // Love note form submission
    loveNoteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      
      const to = document.getElementById("loveNoteTo").value;
      const from = document.getElementById("loveNoteFrom").value;
      const message = document.getElementById("loveNoteMessage").value;
      
      try {
        await db.collection("loveNotes").add({
          to,
          from,
          message,
          authorId: currentUser ? currentUser.uid : null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          likes: 0,
          likesBy: []
        });
        
        loveNoteForm.reset();
        showNotification('Love note posted!', 'success');
        
      } catch (err) {
        console.error("Error posting love note:", err);
        showNotification("Failed to post love note", 'error');
      }
    });

    // Load memories with real-time updates
    function loadMemories(query = null) {
      loadingMemories.classList.remove("hidden");
      memoryGrid.innerHTML = "";
      
      // Unsubscribe from previous listener
      if (memoriesListener) {
        memoriesListener();
      }
      
      let memoriesQuery = query || db.collection("memories").orderBy("createdAt", "desc").limit(20);
      
      memoriesListener = memoriesQuery.onSnapshot((snapshot) => {
        if (snapshot.empty) {
          noMemories.classList.remove("hidden");
          loadingMemories.classList.add("hidden");
          return;
        }
        
        noMemories.classList.add("hidden");
        memoryGrid.innerHTML = "";
        
        snapshot.forEach(doc => {
          const memory = doc.data();
          const memoryId = doc.id;
          
          const memoryCard = document.createElement("div");
          memoryCard.className = "bg-white memory-card shadow-lg rounded-xl overflow-hidden dark:bg-gray-800 dark:text-white";
          memoryCard.innerHTML = `
            <div class="relative">
              <img src="${memory.imageUrl}" class="w-full h-60 object-cover cursor-pointer" alt="${memory.title}" onclick="openMemoryModal('${memoryId}')" />
              ${memory.category ? `<span class="badge absolute top-2 right-2 bg-pink-500 text-white">${memory.category}</span>` : ''}
            </div>
            <div class="p-4">
              <h3 class="text-xl font-semibold text-pink-700 dark:text-pink-400 mb-1">${memory.title}</h3>
              <p class="text-sm text-gray-600 dark:text-gray-300 mb-2">
                by ${memory.authorName} 
                ${memory.authorBatch ? `• Batch ${memory.authorBatch}` : ''} 
                ${memory.createdAt ? `• ${formatDate(memory.createdAt.toDate())}` : ''}
              </p>
              <p class="text-sm text-gray-700 dark:text-gray-300 line-clamp-2 mb-3">${memory.desc}</p>
              <div class="flex justify-between items-center pt-3 border-t border-pink-100 dark:border-gray-700">
                <button class="text-pink-500 hover:text-pink-700 dark:hover:text-pink-400 text-sm font-medium" onclick="openMemoryModal('${memoryId}')">
                  View Memory
                </button>
                <div class="flex items-center space-x-3">
                  <button class="like-btn-card text-gray-400 hover:text-pink-500 dark:hover:text-pink-400 ${memory.likesBy && currentUser && memory.likesBy.includes(currentUser.uid) ? 'liked' : ''}" data-memory-id="${memoryId}">
                    <i class="${memory.likesBy && currentUser && memory.likesBy.includes(currentUser.uid) ? 'fas' : 'far'} fa-heart mr-1"></i> ${memory.likes || 0}
                  </button>
                  <span class="text-xs text-pink-500 dark:text-pink-400 flex items-center">
                    <i class="far fa-comment mr-1"></i> ${memory.comments ? memory.comments.length : 0}
                  </span>
                  <span class="text-xs text-pink-500 dark:text-pink-400 flex items-center">
                    <i class="far fa-eye mr-1"></i> ${memory.views || 0}
                  </span>
                </div>
              </div>
            </div>
          `;
          
          memoryGrid.appendChild(memoryCard);
        });
        
        // Add click event listeners to like buttons
        document.querySelectorAll('.like-btn-card').forEach(btn => {
          btn.addEventListener('click', (e) => {
            e.stopPropagation();
            likeMemory(btn.dataset.memoryId);
          });
        });
        
        loadingMemories.classList.add("hidden");
      }, (error) => {
        console.error("Error loading memories:", error);
        showNotification("Failed to load memories", 'error');
        loadingMemories.classList.add("hidden");
      });
    }

    // Load love notes with real-time updates
    function loadLoveNotes() {
      const loveNotesContainer = document.getElementById("loveNotesContainer");
      loveNotesContainer.innerHTML = "";
      
      db.collection("loveNotes").orderBy("createdAt", "desc").limit(20)
        .onSnapshot((snapshot) => {
          loveNotesContainer.innerHTML = "";
          
          if (snapshot.empty) {
            loveNotesContainer.innerHTML = '<p class="text-center text-gray-500 dark:text-gray-400 italic">No love notes yet. Be the first to spread some love!</p>';
            return;
          }
          
          snapshot.forEach(doc => {
            const note = doc.data();
            const noteId = doc.id;
            const date = note.createdAt ? note.createdAt.toDate() : new Date();
            
            const noteElement = document.createElement("div");
            noteElement.className = "bg-white shadow-md p-5 rounded-xl border-l-4 border-pink-400 dark:bg-gray-800 dark:border-pink-600";
            noteElement.innerHTML = `
              <p class="text-pink-700 dark:text-pink-300">
                <strong class="text-pink-800 dark:text-pink-400">To ${note.to}:</strong> 
                ${note.message} 
                <span class="font-medium">- ${note.from}</span>
              </p>
              <div class="flex justify-between items-center mt-3">
                <span class="text-xs text-pink-500 dark:text-pink-400">${formatDate(date)}</span>
                <button class="like-btn-note text-gray-400 hover:text-pink-500 dark:hover:text-pink-400 ${note.likesBy && currentUser && note.likesBy.includes(currentUser.uid) ? 'liked' : ''}" data-note-id="${noteId}">
                  <i class="${note.likesBy && currentUser && note.likesBy.includes(currentUser.uid) ? 'fas' : 'far'} fa-heart mr-1"></i> ${note.likes || 0}
                </button>
              </div>
            `;
            
            loveNotesContainer.appendChild(noteElement);
          });
          
          // Add like functionality to love notes
          document.querySelectorAll('.like-btn-note').forEach(btn => {
            btn.addEventListener('click', () => likeLoveNote(btn.dataset.noteId));
          });
        });
    }

    // Open memory modal
    async function openMemoryModal(memoryId) {
      currentMemoryId = memoryId;
      
      try {
        // Increment view count
        await db.collection("memories").doc(memoryId).update({
          views: firebase.firestore.FieldValue.increment(1)
        });
        
        const doc = await db.collection("memories").doc(memoryId).get();
        if (!doc.exists) {
          showNotification("Memory not found", 'error');
          return;
        }
        
        const memory = doc.data();
        
        // Set modal content
        document.getElementById('modalImage').src = memory.imageUrl;
        document.getElementById('modalTitle').textContent = memory.title;
        document.getElementById('modalAuthor').textContent = `by ${memory.authorName}`;
        document.getElementById('modalBatch').textContent = memory.authorBatch ? `Batch ${memory.authorBatch}` : '';
        document.getElementById('modalDate').textContent = memory.createdAt ? formatDate(memory.createdAt.toDate()) : '';
        document.getElementById('modalDescription').textContent = memory.desc;
        document.getElementById('modalLikeCount').textContent = memory.likes || 0;
        document.getElementById('modalCommentCount').textContent = memory.comments ? memory.comments.length : 0;
        
        // Set like button state
        const isLiked = memory.likesBy && currentUser && memory.likesBy.includes(currentUser.uid);
        const modalLikeBtn = document.getElementById('modalLikeBtn');
        modalLikeBtn.innerHTML = `<i class="${isLiked ? 'fas' : 'far'} fa-heart"></i> ${memory.likes || 0}`;
        modalLikeBtn.className = `like-btn ${isLiked ? 'liked' : ''} text-gray-400 hover:text-pink-500 dark:hover:text-pink-400`;
        
        // Load comments
        loadModalComments(memory.comments || []);
        
        // Show/hide comment form based on auth and settings
        const commentForm = document.getElementById('commentForm');
        const loginToComment = document.getElementById('loginToComment');
        const modalCommentsSection = document.getElementById('modalCommentsSection');
        
        if (!memory.allowComments) {
          modalCommentsSection.classList.add('hidden');
        } else {
          modalCommentsSection.classList.remove('hidden');
          if (currentUser && !currentUser.isAnonymous) {
            commentForm.classList.remove('hidden');
            loginToComment.classList.add('hidden');
          } else {
            commentForm.classList.add('hidden');
            loginToComment.classList.remove('hidden');
          }
        }
        
        // Show modal
        memoryModal.classList.remove("hidden");
        document.body.style.overflow = "hidden";
        
      } catch (err) {
        console.error("Error opening memory:", err);
        showNotification("Failed to load memory", 'error');
      }
    }

    // Load modal comments
    function loadModalComments(comments) {
      const modalComments = document.getElementById('modalComments');
      modalComments.innerHTML = '';
      
      if (comments.length === 0) {
        modalComments.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 italic">No comments yet</p>';
        return;
      }
      
      // Sort comments by timestamp (newest first)
      const sortedComments = comments.sort((a, b) => {
        if (!a.timestamp || !b.timestamp) return 0;
        return b.timestamp.seconds - a.timestamp.seconds;
      });
      
      sortedComments.forEach(comment => {
        const commentElement = document.createElement("div");
        commentElement.className = "bg-pink-50 dark:bg-gray-700 p-3 rounded-lg";
        commentElement.innerHTML = `
          <div class="flex justify-between items-start">
            <div class="flex-1">
              <p class="text-sm font-medium text-pink-700 dark:text-pink-300">${comment.authorName}</p>
              <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${comment.text}</p>
            </div>
            <p class="text-xs text-pink-400 dark:text-pink-500 ml-2">${comment.timestamp ? formatDate(comment.timestamp.toDate()) : 'Just now'}</p>
          </div>
        `;
        modalComments.appendChild(commentElement);
      });
    }

    // Close memory modal
    closeModal.addEventListener("click", () => {
      memoryModal.classList.add("hidden");
      document.body.style.overflow = "auto";
    });

    // Like memory function
    async function likeMemory(memoryId) {
      if (!currentUser || currentUser.isAnonymous) {
        showNotification("Please login to like memories", 'error');
        return;
      }
      
      try {
        const memoryRef = db.collection("memories").doc(memoryId);
        const doc = await memoryRef.get();
        
        if (!doc.exists) {
          showNotification("Memory not found", 'error');
          return;
        }
        
        const memory = doc.data();
        const isLiked = memory.likesBy && memory.likesBy.includes(currentUser.uid);
        const newLikes = isLiked ? (memory.likes || 0) - 1 : (memory.likes || 0) + 1;
        const newLikesBy = isLiked 
          ? memory.likesBy.filter(id => id !== currentUser.uid)
          : [...(memory.likesBy || []), currentUser.uid];
        
        await memoryRef.update({
          likes: newLikes,
          likesBy: newLikesBy
        });
        
        // Update user's likes count
        if (!isLiked) {
          await db.collection('users').doc(currentUser.uid).update({
            likesCount: firebase.firestore.FieldValue.increment(1)
          });
        } else {
          await db.collection('users').doc(currentUser.uid).update({
            likesCount: firebase.firestore.FieldValue.increment(-1)
          });
        }
        
      } catch (err) {
        console.error("Error liking memory:", err);
        showNotification("Failed to like memory", 'error');
      }
    }

    // Like love note
    async function likeLoveNote(noteId) {
      if (!currentUser || currentUser.isAnonymous) {
        showNotification("Please login to like notes", 'error');
        return;
      }
      
      try {
        const noteRef = db.collection("loveNotes").doc(noteId);
        const doc = await noteRef.get();
        
        if (!doc.exists) {
          showNotification("Note not found", 'error');
          return;
        }
        
        const note = doc.data();
        const isLiked = note.likesBy && note.likesBy.includes(currentUser.uid);
        const newLikes = isLiked ? (note.likes || 0) - 1 : (note.likes || 0) + 1;
        const newLikesBy = isLiked 
          ? note.likesBy.filter(id => id !== currentUser.uid)
          : [...(note.likesBy || []), currentUser.uid];
        
        await noteRef.update({
          likes: newLikes,
          likesBy: newLikesBy
        });
        
      } catch (err) {
        console.error("Error liking love note:", err);
        showNotification("Failed to like note", 'error');
      }
    }

    // Modal like button event listener
    document.getElementById('modalLikeBtn').addEventListener('click', () => {
      if (currentMemoryId) {
        likeMemory(currentMemoryId);
      }
    });

    // Add comment to memory
    document.getElementById('commentForm').addEventListener("submit", async (e) => {
      e.preventDefault();
      
      if (!currentUser || currentUser.isAnonymous) {
        showNotification("Please login to comment", 'error');
        return;
      }
      
      const commentInput = document.getElementById('commentInput');
      const commentText = commentInput.value.trim();
      if (!commentText) return;
      
      try {
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data();
        
        const newComment = {
          authorId: currentUser.uid,
          authorName: `${userData.firstName} ${userData.lastName}`,
          text: commentText,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        await db.collection("memories").doc(currentMemoryId).update({
          comments: firebase.firestore.FieldValue.arrayUnion(newComment)
        });
        
        // Clear input
        commentInput.value = "";
        
        showNotification('Comment added!', 'success');
        
        // Reload the modal to show the new comment
        setTimeout(() => {
          openMemoryModal(currentMemoryId);
        }, 500);
        
      } catch (err) {
        console.error("Error adding comment:", err);
        showNotification("Failed to add comment", 'error');
      }
    });

    // Search functionality
    let searchTimeout;
    searchInput.addEventListener("input", (e) => {
      clearTimeout(searchTimeout);
      const searchTerm = e.target.value.toLowerCase().trim();
      
      searchTimeout = setTimeout(() => {
        if (searchTerm.length > 2) {
          // Search in title and description
          const searchQuery = db.collection("memories")
            .where("title", ">=", searchTerm)
            .where("title", "<=", searchTerm + '\uf8ff')
            .orderBy("title");
          loadMemories(searchQuery);
        } else if (searchTerm.length === 0) {
          loadMemories();
        }
      }, 500);
    });

    // Sort functionality
    sortNewest.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("createdAt", "desc").limit(20));
      updateSortButtons('newest');
    });

    sortOldest.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("createdAt", "asc").limit(20));
      updateSortButtons('oldest');
    });

    sortPopular.addEventListener("click", () => {
      loadMemories(db.collection("memories").orderBy("likes", "desc").limit(20));
      updateSortButtons('popular');
    });

    function updateSortButtons(active) {
      [sortNewest, sortOldest, sortPopular].forEach(btn => {
        btn.classList.remove("bg-pink-300");
        btn.classList.add("bg-pink-100");
      });
      
      switch(active) {
        case 'newest':
          sortNewest.classList.add("bg-pink-300");
          break;
        case 'oldest':
          sortOldest.classList.add("bg-pink-300");
          break;
        case 'popular':
          sortPopular.classList.add("bg-pink-300");
          break;
      }
    }

    // Format date function
    function formatDate(date) {
      const now = new Date();
      const diff = now.getTime() - date.getTime();
      const diffDays = Math.ceil(diff / (1000 * 3600 * 24));
      
      if (diffDays === 1) {
        return 'Yesterday';
      } else if (diffDays < 7) {
        return `${diffDays} days ago`;
      } else {
        const options = { year: 'numeric', month: 'short', day: 'numeric' };
        return date.toLocaleDateString('en-US', options);
      }
    }

    // Share functionality
    document.getElementById('modalShareBtn').addEventListener('click', async () => {
      if (navigator.share) {
        try {
          await navigator.share({
            title: 'MACE Memories',
            text: 'Check out this memory from MACE!',
            url: window.location.href
          });
        } catch (err) {
          console.log('Error sharing:', err);
        }
      } else {
        // Fallback: copy link to clipboard
        try {
          await navigator.clipboard.writeText(window.location.href);
          showNotification('Link copied to clipboard!', 'success');
        } catch (err) {
          showNotification('Could not copy link', 'error');
        }
      }
    });

    // Smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });

    // Close modal when clicking outside
    memoryModal.addEventListener('click', (e) => {
      if (e.target === memoryModal) {
        memoryModal.classList.add('hidden');
        document.body.style.overflow = 'auto';
      }
    });

    authModal.addEventListener('click', (e) => {
      if (e.target === authModal) {
        authModal.classList.add('hidden');
      }
    });

    // Initialize the app
    function init() {
      // Load initial data
      loadMemories();
      loadLoveNotes();
      
      // Set default sort
      updateSortButtons('newest');
      
      // Clear any cached auth errors
      document.getElementById('authError').classList.add('hidden');
      document.getElementById('authSuccess').classList.add('hidden');
      
      // Reset forms
      if (memoryForm) memoryForm.reset();
      if (loveNoteForm) loveNoteForm.reset();
      if (loginForm) loginForm.reset();
      if (signupForm) signupForm.reset();
    }

    // Start the app when DOM is loaded
    window.addEventListener("DOMContentLoaded", init);

    // Handle online/offline status
    window.addEventListener('online', () => {
      showNotification('Connection restored', 'success');
    });

    window.addEventListener('offline', () => {
      showNotification('No internet connection', 'error');
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Escape key to close modals
      if (e.key === 'Escape') {
        if (!memoryModal.classList.contains('hidden')) {
          memoryModal.classList.add('hidden');
          document.body.style.overflow = 'auto';
        }
        if (!authModal.classList.contains('hidden')) {
          authModal.classList.add('hidden');
        }
      }
      
      // Ctrl/Cmd + K to focus search
      if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
        e.preventDefault();
        searchInput.focus();
      }
    });

    // Service Worker Registration (for PWA capabilities)
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
          .then(registration => {
            console.log('SW registered: ', registration);
          })
          .catch(registrationError => {
            console.log('SW registration failed: ', registrationError);
          });
      });
    }

  </script>
</body>
</html>
